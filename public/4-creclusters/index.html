<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.148.2">
    <meta name="description" content="">
<meta name="author" content="journeyoftheaverageguy@gmail.com">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Create Workload Cluster :: Kubernetes Multi-Cluster Management with Cluster API</title>

    
    <link href="/css/nucleus.css?1754751022" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1754751022" rel="stylesheet">
    <link href="/css/hybrid.css?1754751022" rel="stylesheet">
    <link href="/css/featherlight.min.css?1754751022" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1754751022" rel="stylesheet">
    <link href="/css/auto-complete.css?1754751022" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1754751022" rel="stylesheet">
    <link href="/css/theme.css?1754751022" rel="stylesheet">
    <link href="/css/hugo-theme.css?1754751022" rel="stylesheet">
    
    <link href="/css/theme-workshop.css?1754751022" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1754751022"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/4-creclusters/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1754751022"></script>
<script type="text/javascript" src="/js/auto-complete.js?1754751022"></script>
<script type="text/javascript">
    
        var baseurl = "\/\/localhost:1313\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1754751022"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/1-introduce/" title="Introduction" class="dd-item 
        
        
        
        ">
      <a href="/1-introduce/">
          <b>1. </b>Introduction
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2-prerequiste/" title="Preparation " class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/">
           <b> 2. </b> Preparation 
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.1-awscli/" title="Install and configure AWS CLI" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.1-awscli/">
           <b> 2.1 </b> Install and configure AWS CLI
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.2-tools/" title="Install tools" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.2-tools/">
           <b> 2.2 </b> Install tools
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.2-tools/2.2.1-kubectl/" title="Kubectl (CLI for Kubernet)" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.2-tools/2.2.1-kubectl/">
           <b> 2.2.1 </b> Kubectl (CLI for Kubernet)
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.2-tools/2.2.2-eksctl/" title="Eksctl (CLI for Amazon EKS)" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.2-tools/2.2.2-eksctl/">
           <b> 2.2.2 </b> Eksctl (CLI for Amazon EKS)
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.2-tools/2.2.3-clusterctl/" title="Clusterctl (CLI for Cluster API)" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.2-tools/2.2.3-clusterctl/">
           <b> 2.2.3 </b> Clusterctl (CLI for Cluster API)
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.2-tools/2.2.4.clusterawsadm/" title="Clusterawsadm" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.2-tools/2.2.4.clusterawsadm/">
           <b> 2.2.4 </b> Clusterawsadm
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.2-tools/2.2.5-kind/" title="Kind" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.2-tools/2.2.5-kind/">
           <b> 2.2.5 </b> Kind
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.2-tools/docker/" title="Docker" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.2-tools/docker/">
           <b> 2.2.6 </b> Docker
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.3-creec2keypair/" title="Create EC2 Keypair" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.3-creec2keypair/">
           <b> 2.3 </b> Create EC2 Keypair
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.4-cres3/" title="Create S3 Bucket" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.4-cres3/">
           <b> 2.4 </b> Create S3 Bucket
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/3-iniclusters/" title="Initialize Cluster API Management Cluster" class="dd-item 
        
        
        
        ">
      <a href="/3-iniclusters/">
           <b> 3. </b> Initialize Cluster API Management Cluster
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/4-creclusters/" title="Create Workload Cluster" class="dd-item 
        
        active
        
        ">
      <a href="/4-creclusters/">
           <b> 4. </b> Create Workload Cluster
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/5-networking/" title="Set Up Cross-Cluster Networking" class="dd-item 
        
        
        
        ">
      <a href="/5-networking/">
           <b> 5. </b> Set Up Cross-Cluster Networking
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/6-distribution/" title="Workload Distribution" class="dd-item 
        
        
        
        ">
      <a href="/6-distribution/">
           <b> 6. </b> Workload Distribution
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/7-security/" title="Implement Governance and Security" class="dd-item 
        
        
        
        ">
      <a href="/7-security/">
           <b> 7. </b> Implement Governance and Security
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/8-cost/" title="Cost Management" class="dd-item 
        
        
        
        ">
      <a href="/8-cost/">
           <b> 8. </b> Cost Management
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/9-procedures/" title="Operational Procedures" class="dd-item 
        
        
        
        ">
      <a href="/9-procedures/">
           <b> 9. </b> Operational Procedures
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/10-cleanup/" title="Clean up resources" class="dd-item 
        
        
        
        ">
      <a href="/10-cleanup/">
          <b>10. </b>Clean up resources
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://www.facebook.com/groups/awsstudygroupfcj/"><i class='fab fa-facebook'></i> AWS Study Group</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="//localhost:1313/4-creclusters/" selected>English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="vi" value="//localhost:1313/vi/4-creclusters/">Tiếng Việt</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
    
     <b> Workshop</b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title="Migrate" Alt="web counter"   border="0" /></a>  <br>
     <b> <a href="https://cloudjourney.awsstudygroup.com/">Cloud Journey</a></b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" Alt="web counter"   border="0"   />
     
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>30-07-2025</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Team </b> <br>
           
            <i> 
                <a href="https://www.linkedin.com/in/nguyentung1812/"  style="color:orange">Nguyễn Thanh Tùng  </a> <br>
               
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            <a href='/'>Kubernetes Multi-Cluster Management with Cluster API</a> > Create Workload Cluster
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#generate-the-kubernetes-cluster-manifests">Generate the Kubernetes Cluster Manifests</a></li>
    <li><a href="#install-argo-cd-on-the-management-kubernetes-cluster">Install Argo CD on the management Kubernetes cluster</a></li>
    <li><a href="#create-workload-clusters">Create Workload Clusters</a>
      <ul>
        <li><a href="#create-clusters-for-k8s-cluster-that-runs-on-ec2">Create Clusters for K8S cluster that runs on EC2:</a></li>
      </ul>
    </li>
    <li><a href="#cluster-upgrades">Cluster Upgrades</a></li>
    <li><a href="#cluster-autoscaling">Cluster Autoscaling</a>
      <ul>
        <li><a href="#1-ec2-based-cluster-autoscaling">1. EC2-Based Cluster Autoscaling</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Create Workload Cluster
            </h1>
          

        



	<h2 id="generate-the-kubernetes-cluster-manifests">Generate the Kubernetes Cluster Manifests</h2>
<ol>
<li><strong>Create the SSH key</strong>:</li>
</ol>
<pre tabindex="0"><code>aws ec2 create-key-pair --key-name capi-eks --region ap-southeast-2 --query &#39;KeyMaterial&#39; --output text &gt; capi-eks.pem
aws ec2 create-key-pair --key-name capi-ec2 --region us-east-1 --query &#39;KeyMaterial&#39; --output text &gt; capi-ec2.pem
</code></pre><ol start="2">
<li><strong>Define environment variables</strong>:</li>
</ol>
<pre tabindex="0"><code>export AWS_CONTROL_PLANE_MACHINE_TYPE=t3.medium
export AWS_NODE_MACHINE_TYPE=t3.medium
</code></pre><ol start="3">
<li><strong>Generate the Kubernetes Cluster Manifest for EC2</strong>:</li>
</ol>
<pre tabindex="0"><code>export AWS_SSH_KEY_NAME=capi-ec2 (Given we are deploying the EC2 cluster and EKS cluster in different regions)
export AWS_REGION=us-east-1 
clusterctl generate cluster capi-ec2 --kubernetes-version v1.31.0 --control-plane-machine-count=3 --worker-machine-count=3 &gt; ./capi-cluster/aws-ec2/aws-ec2.yaml
</code></pre><ol start="4">
<li><strong>Generate the Kubernetes Cluster Manifest for EKS</strong>:</li>
</ol>
<pre tabindex="0"><code>export AWS_SSH_KEY_NAME=capi-eks
export AWS_REGION=ap-southeast-2
clusterctl generate cluster capi-eks --flavor eks-managedmachinepool --kubernetes-version v1.31.0 --worker-machine-count=3 &gt; ./capi-cluster/aws-eks/capi-eks.yaml
</code></pre><h2 id="install-argo-cd-on-the-management-kubernetes-cluster">Install Argo CD on the management Kubernetes cluster</h2>
<p><strong>install Argo CD in the Kind management cluster:</strong></p>
<pre tabindex="0"><code>kubectl apply -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
</code></pre><p><strong>Get the first login password to Argo CD Web UI:</strong></p>
<pre tabindex="0"><code>kubectl get secret argocd-initial-admin-secret -o jsonpath=&#34;{.data.password}&#34; | base64 -d; echo
</code></pre><p><strong>Set up Argo CD can be authenticated to Git</strong></p>
<ul>
<li>
<p><strong>Login Argo CD’s web portal:</strong></p>
<pre tabindex="0"><code>kubectl port-forward svc/argocd-server 8080:80
</code></pre><ul>
<li>Username: admin</li>
<li>password: <code>first login password</code>
<img src="/images/4.workload/001-workload.png" alt="workload"></li>
</ul>
</li>
<li>
<p>Navigate setting &gt; Repositories &gt; Connect repo</p>
<ul>
<li>Choose your connection method: HTTP/HTTPS</li>
<li>Type: Git</li>
<li>Repository URL: Your url fork repo</li>
<li>Select <code>skip server verification</code>
<img src="/images/4.workload/003-workload.png" alt="workload">
<img src="/images/4.workload/002-workload.png" alt="workload"></li>
</ul>
</li>
<li>
<p>Connect</p>
</li>
</ul>
<h2 id="create-workload-clusters">Create Workload Clusters</h2>
<p><strong>To authorize Argo CD to manage Cluster API objects, create a ClusterRoleBinding to grant the necessary permissions to the argocd-application-controller ServiceAccount, using the cluster-admin role for simplicity.</strong></p>
<pre tabindex="0"><code>kubectl apply -f ./management/argo-cluster-role-binding.yaml
</code></pre><pre tabindex="0"><code>apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cluster-admin-argocd-contoller
subjects:
  - kind: ServiceAccount
    name: argocd-application-controller
    namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
</code></pre><h3 id="create-clusters-for-k8s-cluster-that-runs-on-ec2">Create Clusters for K8S cluster that runs on EC2:</h3>
<p>To create a new EKS cluster or a K8S cluster that runs on EC2, we can first define an application in a declarative approach, as a representation of a collection of Kubernetes manifests that makes up all the pieces to deploy the new cluster. In this guide, all of the configuration of the Argo CD application to be added is stored in “Management” folder of the cloned repository. For example, below is the application manifest file for creating a new K8S cluster that runs on EC2:</p>
<pre tabindex="0"><code>apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: ec2-cluster
spec:
  destination:
    name: &#39;&#39;
    namespace: &#39;default&#39;
    server: &#39;https://kubernetes.default.svc&#39;
  source:
    path: capi-cluster/aws-ec2
    repoURL: &#39;[update the Git Repo accordingly]&#39; #Indicate which source repo for fetching the cluster configuration
    targetRevision: HEAD
  project: default #You can give a project name here
  syncPolicy:
    automated:
      prune: true
      allowEmpty: true
</code></pre><p>After modifying the Argo CD application yaml file as above, commit and push the updates to the source repo:</p>
<pre tabindex="0"><code>git push .
git add .
git commit -m “updates Argo CD app manifest file” 
</code></pre><p>Run the following command to create a new Application to create the K8S cluster that runs on EC2:</p>
<pre tabindex="0"><code>kubectl apply -f ./management/argocd-ec2-app.yaml
</code></pre><p>We will use an Argo CD application to provision the EKS cluster. First, create an application and update the relevant YAML file to set the repoURL to your Git repository. Then, commit and push the changes to the source repository.</p>
<pre tabindex="0"><code>kubectl apply -f ./management/argocd-eks-app.yaml
</code></pre><p>Check status of the clusters</p>
<pre tabindex="0"><code>clusterctl describe cluster capi-eks
clusterctl describe cluster capi-ec2
</code></pre><p>The EC2 cluster&rsquo;s worker nodes show a &ldquo;False&rdquo; READY status due to the absence of a CNI, preventing them from joining the cluster. For demonstration, deploy the Calico CNI to the EC2 cluster, which can be automated using Argo CD.</p>
<p>Fetch the kubeconfig file for the newly created cluster on EC2:</p>
<pre tabindex="0"><code>clusterctl get kubeconfig capi-ec2 &gt; capikubeconfig-ec2
</code></pre><p>Deploy Calico CNI</p>
<pre tabindex="0"><code>kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
</code></pre><p>Calico CNI is successfully deployed, check the cluster status again</p>
<p>When creating an EKS cluster, the system automatically generates and stores kubeconfig files as secrets within the management cluster. This behavior differs from creating a non-managed cluster using the AWS provider, where kubeconfigs are not stored in this way. The secret containing the kubeconfig will be named [cluster-name]-user-kubeconfig, where you should replace [cluster-name] with the actual name of your cluster.</p>
<p>To get the user kubeconfig for a cluster named ‘capi-eks’ you can run a command similar to:</p>
<pre tabindex="0"><code>kubectl --namespace=default get secret capi-eks-user-kubeconfig -o jsonpath={.data.value} | base64 --decode &gt; capikubeconfig-eks
</code></pre><h2 id="cluster-upgrades">Cluster Upgrades</h2>
<ol>
<li><strong>Choose the target Kubernetes version</strong> (e.g., <code>v1.32.0</code>).</li>
<li><strong>Update your cluster manifest</strong>:</li>
</ol>
<ul>
<li>
<p>Open your EC2 manifest file <code>aws-ec2.yaml</code>.</p>
<ul>
<li>
<p>Modify the <code>version</code> field in <code>KubeadmControlPlane</code> and <code>MachineDeployment</code>:
<img src="/images/4.workload/005-workload.png" alt="workload">
<img src="/images/4.workload/006-workload.png" alt="workload"></p>
</li>
<li>
<p>Ensure the MachineDeployment is configured to handle rolling updates</p>
<pre tabindex="0"><code>spec:
strategy:
   type: RollingUpdate
   rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
</code></pre><p><img src="/images/4.workload/010-workload.png" alt="workload"></p>
</li>
<li>
<p>Commit and push</p>
</li>
<li>
<p>Check in argo cd UI
<img src="/images/4.workload/007-workload.png" alt="workload"></p>
</li>
</ul>
</li>
<li>
<p>Open your EC2 manifest file <code>capi-eks.yaml</code>.</p>
<ul>
<li>Modify the <code>version</code> field in <code>AWSManagedControlPlane</code>:
<img src="/images/4.workload/008-workload.png" alt="workload"></li>
<li>Commit and push</li>
<li>Check in argo cd UI
<img src="/images/4.workload/009-workload.png" alt="workload"></li>
</ul>
</li>
</ul>
<hr>
<h2 id="cluster-autoscaling">Cluster Autoscaling</h2>
<p>Autoscaling allows your clusters to dynamically adjust resources based on workload demand.</p>
<h3 id="1-ec2-based-cluster-autoscaling">1. EC2-Based Cluster Autoscaling</h3>
<h4 id="manifest-cluster-autoscaler">Manifest Cluster Autoscaler</h4>
<p>Create file <code>management/cluster-autoscaler.yaml</code>:</p>
<pre tabindex="0"><code>apiVersion: apps/v1
kind: Deployment
metadata:
name: cluster-autoscaler
namespace: kube-system
labels:
   app: cluster-autoscaler
spec:
replicas: 1
selector:
   matchLabels:
      app: cluster-autoscaler
template:
   metadata:
      labels:
      app: cluster-autoscaler
      annotations:
      cluster-autoscaler.kubernetes.io/safe-to-evict: &#34;false&#34;
      prometheus.io/scrape: &#34;true&#34;
      prometheus.io/port: &#34;8085&#34;
   spec:
      serviceAccountName: cluster-autoscaler
      containers:
      - name: cluster-autoscaler
         image: registry.k8s.io/autoscaling/cluster-autoscaler:v1.32.0
         resources:
            limits:
            cpu: 100m
            memory: 300Mi
            requests:
            cpu: 100m
            memory: 300Mi
         command:
            - ./cluster-autoscaler
            - --cloud-provider=aws
            - --nodes=1:10:capi-ec2-md-0
            - --cluster-name=capi-ec2
            - --skip-nodes-with-local-storage=false
            - --balance-similar-node-groups
            - --expander=least-waste
            - --logtostderr=true
            - --v=4
         volumeMounts:
            - name: ssl-certs
            mountPath: /etc/ssl/certs/ca-certificates.crt
            readOnly: true
         securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 65534
      volumes:
      - name: ssl-certs
         hostPath:
            path: /etc/ssl/certs/ca-certificates.crt
</code></pre><h4 id="rbac-for-autoscaler">RBAC for autoscaler</h4>
<p>Create file <code>management/cluster-autoscaler-rbac.yaml</code>:</p>
<pre tabindex="0"><code>apiVersion: v1
kind: ServiceAccount
metadata:
name: cluster-autoscaler
namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: cluster-autoscaler
rules:
- apiGroups: [&#34;&#34;]
   resources: [&#34;events&#34;, &#34;endpoints&#34;, &#34;pods&#34;, &#34;services&#34;, &#34;nodes&#34;, &#34;namespaces&#34;]
   verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;]
- apiGroups: [&#34;apps&#34;]
   resources: [&#34;replicasets&#34;, &#34;statefulsets&#34;, &#34;daemonsets&#34;]
   verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;]
- apiGroups: [&#34;extensions&#34;]
   resources: [&#34;replicasets&#34;, &#34;daemonsets&#34;]
   verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;]
- apiGroups: [&#34;policy&#34;]
   resources: [&#34;poddisruptionbudgets&#34;]
   verbs: [&#34;get&#34;, &#34;list&#34;]
- apiGroups: [&#34;autoscaling.k8s.io&#34;]
   resources: [&#34;*&#34;]
   verbs: [&#34;*&#34;]
- apiGroups: [&#34;cluster.x-k8s.io&#34;]
   resources: [&#34;machinedeployments&#34;, &#34;machinesets&#34;, &#34;machines&#34;]
   verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;, &#34;patch&#34;]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
name: cluster-autoscaler
roleRef:
apiGroup: rbac.authorization.k8s.io
kind: ClusterRole
name: cluster-autoscaler
subjects:
- kind: ServiceAccount
   name: cluster-autoscaler
   namespace: kube-system
</code></pre><h4 id="manifest-argo-cd-application-cluster-autoscaler">Manifest Argo CD Application Cluster Autoscaler</h4>
<p>Create file <code>management/argocd-autoscaler-app.yaml</code>:</p>
<pre tabindex="0"><code>apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cluster-autoscaler
spec:
  project: default
  source:
    repoURL: https://github.com/Tungdever/multi-cluster-with-clusterapi
    targetRevision: HEAD
    path: management
  destination:
    server: https://kubernetes.default.svc
    namespace: kube-system
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
</code></pre><ul>
<li>Commit file <code>cluster-autoscaler.yaml</code>, <code>cluster-autoscaler-rbac.yaml</code>, and <code>argocd-autoscaler-app.yaml</code></li>
<li>Push on repo</li>
<li>Apply Argo CD Application:
<pre tabindex="0"><code>kubectl apply -f management/argocd-autoscaler-app.yaml
</code></pre></li>
</ul>
<p><img src="/images/4.workload/011-workload.png" alt="workload">
<img src="/images/4.workload/012-workload.png" alt="workload"></p>
<h4 id="eks-cluster-autoscaling">EKS Cluster Autoscaling</h4>
<ul>
<li><strong>Use managed node groups</strong> with autoscaling parameters:</li>
</ul>
<pre tabindex="0"><code>apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: AWSManagedMachinePool
metadata:
  name: capi-eks-pool-0
  namespace: default
spec:
  instanceType: t3.medium
  scaling:
    maxSize: 5
    minSize: 1
</code></pre><p><img src="/images/4.workload/013-workload.png" alt="workload">
<img src="/images/4.workload/014-workload.png" alt="workload"></p>
<ul>
<li>Alternatively, deploy Cluster Autoscaler for EKS if you&rsquo;re using unmanaged node groups.</li>
</ul>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/3-iniclusters/" title="Initialize Cluster API Management Cluster"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/5-networking/" title="Set Up Cross-Cluster Networking" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1754751022"></script>
    <script src="/js/perfect-scrollbar.min.js?1754751022"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1754751022"></script>
    <script src="/js/jquery.sticky.js?1754751022"></script>
    <script src="/js/featherlight.min.js?1754751022"></script>
    <script src="/js/highlight.pack.js?1754751022"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1754751022"></script>
    <script src="/js/learn.js?1754751022"></script>
    <script src="/js/hugo-learn.js?1754751022"></script>

    <link href="/mermaid/mermaid.css?1754751022" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1754751022"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
